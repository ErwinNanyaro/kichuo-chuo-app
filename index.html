// Firebase configuration (replace with your actual config)
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);

// Configuration
const config = {
  backendUrl: 'http://localhost:5000',
  defaultAvatarBgColors: ['#3a86ff', '#8338ec', '#06d6a0', '#ef476f', '#ffd166']
};

// DOM Elements
const authSection = document.getElementById('auth-section');
const appContainer = document.getElementById('app-container');
const loginForm = document.getElementById('login-form');
const loginPhoneInput = document.getElementById('login-phone');
const userAvatar = document.getElementById('user-avatar');
const userName = document.getElementById('user-name');
const fromInput = document.getElementById('from');
const toInput = document.getElementById('to');
const fromSuggestions = document.getElementById('from-suggestions');
const toSuggestions = document.getElementById('to-suggestions');
const findRideBtn = document.getElementById('find-ride-btn');
const rideResults = document.getElementById('ride-results');
const vehicleOptions = document.getElementById('vehicle-options');
const riderDetails = document.getElementById('rider-details');
const riderAvatar = document.getElementById('rider-avatar');
const riderName = document.getElementById('rider-name');
const riderPhone = document.getElementById('rider-phone');
const rideVehicle = document.getElementById('ride-vehicle');
const rideFrom = document.getElementById('ride-from');
const rideTo = document.getElementById('ride-to');
const rideTime = document.getElementById('ride-time');
const ridePrice = document.getElementById('ride-price');
const confirmRideBtn = document.getElementById('confirm-ride-btn');
const rideConfirmation = document.getElementById('ride-confirmation');
const confirmationDetails = document.getElementById('confirmation-details');
const trackRideBtn = document.getElementById('track-ride-btn');

// State
let currentUser = null;
let selectedVehicle = null;
let selectedRider = null;
let currentRide = null;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  checkAuthState();
  setupEventListeners();
});

function checkAuthState() {
  const userData = localStorage.getItem('user');
  if (userData) {
    currentUser = JSON.parse(userData);
    showApp();
  }
}

function showApp() {
  authSection.classList.add('hidden');
  appContainer.classList.remove('hidden');
  
  // Set user info
  if (currentUser) {
    const initials = currentUser.firstName.charAt(0) + currentUser.lastName.charAt(0);
    userAvatar.textContent = initials;
    userName.textContent = `${currentUser.firstName} ${currentUser.lastName}`;
    setRandomAvatarBg(userAvatar);
  }
}

function setupEventListeners() {
  // Login form
  if (loginForm) {
    loginForm.addEventListener('submit', handleLogin);
  }

  // Location inputs
  fromInput.addEventListener('input', () => handleLocationInput(fromInput, fromSuggestions, 'from-zone'));
  toInput.addEventListener('input', () => handleLocationInput(toInput, toSuggestions, 'to-zone'));

  // Find ride button
  findRideBtn.addEventListener('click', findRides);

  // Confirm ride button
  confirmRideBtn.addEventListener('click', confirmRide);

  // Track ride button
  trackRideBtn.addEventListener('click', trackRide);
}

async function handleLogin(e) {
  e.preventDefault();
  const phone = loginPhoneInput.value.trim();

  if (!phone) {
    showAlert('Please enter your phone number', 'error');
    return;
  }

  try {
    const response = await fetch(`${config.backendUrl}/api/login-passenger`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ mobileContact: phone }),
    });

    const data = await response.json();

    if (data.success) {
      currentUser = data.user;
      localStorage.setItem('user', JSON.stringify(data.user));
      showApp();
      showAlert(`Welcome back, ${data.user.firstName}!`, 'success');
    } else {
      showAlert(data.message || 'Login failed. Please try again.', 'error');
    }
  } catch (error) {
    console.error('Login error:', error);
    showAlert('An error occurred during login. Please try again.', 'error');
  }
}

function handleLocationInput(inputElement, suggestionsContainer, zoneElementId) {
  const inputValue = inputElement.value.toLowerCase();
  suggestionsContainer.innerHTML = '';

  if (!inputValue) {
    suggestionsContainer.style.display = 'none';
    return;
  }

  // In a real app, you would fetch these from your backend
  const mockLocations = [
    { name: "Mzumbe University", zone: "Zone A" },
    { name: "Uswazi Chini", zone: "Zone B" },
    { name: "Campus", zone: "Zone C" },
    { name: "Mzumbe University", zone: "Zone A" },
    { name: "Vikenge", zone: "Zone D" }
  ];

  const filtered = mockLocations.filter(loc =>
    loc.name.toLowerCase().includes(inputValue)
  );

  if (filtered.length > 0) {
    filtered.forEach(loc => {
      const suggestion = document.createElement('div');
      suggestion.className = 'suggestion-item';
      suggestion.textContent = loc.name;
      suggestion.onclick = () => {
        inputElement.value = loc.name;
        document.getElementById(zoneElementId).value = loc.zone || '';
        suggestionsContainer.innerHTML = '';
        suggestionsContainer.style.display = 'none';
      };
      suggestionsContainer.appendChild(suggestion);
    });
    suggestionsContainer.style.display = 'block';
  } else {
    suggestionsContainer.style.display = 'none';
  }
}

async function findRides() {
  const from = fromInput.value;
  const to = toInput.value;

  if (!from || !to) {
    showAlert('Please enter both pickup and destination locations', 'error');
    return;
  }

  try {
    showLoader(findRideBtn, 'Finding rides...');

    // In a real app, you would fetch this from your backend
    const mockRides = [
      {
        vehicleType: "Motorcycle",
        price: "3,000",
        time: "10 min",
        image: "motorbike.png"
      },
      {
        vehicleType: "Bajaji",
        price: "5,000",
        time: "15 min",
        image: "tuktuk.png"
      },
      {
        vehicleType: "Car",
        price: "8,000",
        time: "12 min",
        image: "taxi.png"
      }
    ];

    displayRideOptions(mockRides);
  } catch (error) {
    console.error('Error finding rides:', error);
    showAlert('Failed to find rides. Please try again.', 'error');
  } finally {
    hideLoader(findRideBtn, 'Find Rides');
  }
}

function displayRideOptions(rides) {
  vehicleOptions.innerHTML = '';
  
  rides.forEach(ride => {
    const card = document.createElement('div');
    card.className = 'vehicle-card';
    card.dataset.vehicle = ride.vehicleType;
    
    card.innerHTML = `
      <img src="${ride.image}" alt="${ride.vehicleType}">
      <p>${ride.vehicleType}</p>
      <p class="price">${ride.price} TZS</p>
      <small>${ride.time} away</small>
    `;
    
    card.addEventListener('click', () => selectRideOption(ride));
    vehicleOptions.appendChild(card);
  });
  
  rideResults.classList.remove('hidden');
}

function selectRideOption(ride) {
  selectedVehicle = ride.vehicleType;
  
  // Remove selected class from all cards
  document.querySelectorAll('.vehicle-card').forEach(card => {
    card.classList.remove('selected');
  });
  
  // Add selected class to clicked card
  event.currentTarget.classList.add('selected');
  
  // In a real app, you would fetch rider details from your backend
  const mockRider = {
    name: "John Doe",
    phone: "0712345678",
    rating: "4.9",
    rides: "120",
    vehicle: ride.vehicleType,
    from: fromInput.value,
    to: toInput.value,
    price: ride.price,
    time: ride.time
  };
  
  displayRiderDetails(mockRider);
}

function displayRiderDetails(rider) {
  selectedRider = rider;
  
  // Set rider details
  riderName.textContent = rider.name;
  riderPhone.textContent = rider.phone;
  rideVehicle.textContent = rider.vehicle;
  rideFrom.textContent = rider.from;
  rideTo.textContent = rider.to;
  rideTime.textContent = rider.time;
  ridePrice.textContent = `${rider.price} TZS`;
  
  // Set rider avatar
  const initials = rider.name.split(' ').map(n => n.charAt(0)).join('');
  riderAvatar.textContent = initials;
  setRandomAvatarBg(riderAvatar);
  
  riderDetails.classList.remove('hidden');
  riderDetails.scrollIntoView({ behavior: 'smooth' });
}

async function confirmRide() {
  if (!selectedRider || !currentUser) {
    showAlert('Please select a ride option first', 'error');
    return;
  }

  try {
    showLoader(confirmRideBtn, 'Confirming...');

    // In a real app, you would send this to your backend
    const rideData = {
      passengerId: currentUser.id,
      passengerName: `${currentUser.firstName} ${currentUser.lastName}`,
      passengerPhone: currentUser.phone,
      riderName: selectedRider.name,
      riderPhone: selectedRider.phone,
      vehicleType: selectedRider.vehicle,
      from: selectedRider.from,
      to: selectedRider.to,
      price: selectedRider.price,
      time: selectedRider.time
    };

    // Simulate API call delay
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    currentRide = rideData;
    showRideConfirmation(rideData);
  } catch (error) {
    console.error('Error confirming ride:', error);
    showAlert('Failed to confirm ride. Please try again.', 'error');
  } finally {
    hideLoader(confirmRideBtn, 'Confirm Ride');
  }
}

function showRideConfirmation(ride) {
  riderDetails.classList.add('hidden');
  rideConfirmation.classList.remove('hidden');
  
  confirmationDetails.innerHTML = `
    <div class="ride-summary">
      <div class="ride-summary-item">
        <span class="label">Rider:</span>
        <span class="value">${ride.riderName}</span>
      </div>
      <div class="ride-summary-item">
        <span class="label">Vehicle:</span>
        <span class="value">${ride.vehicleType}</span>
      </div>
      <div class="ride-summary-item">
        <span class="label">From:</span>
        <span class="value">${ride.from}</span>
      </div>
      <div class="ride-summary-item">
        <span class="label">To:</span>
        <span class="value">${ride.to}</span>
      </div>
      <div class="ride-summary-item">
        <span class="label">Price:</span>
        <span class="value">${ride.price} TZS</span>
      </div>
    </div>
  `;
  
  showAlert('Your ride has been confirmed!', 'success');
}

function trackRide() {
  showAlert('Ride tracking will be implemented soon!', 'info');
  // In a real app, you would implement ride tracking here
}

// Utility functions
function showAlert(message, type) {
  // In a real app, you would use a proper notification system
  alert(`${type.toUpperCase()}: ${message}`);
}

function showLoader(button, text) {
  button.disabled = true;
  button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${text}`;
}

function hideLoader(button, text) {
  button.disabled = false;
  button.textContent = text;
}

function setRandomAvatarBg(element) {
  const randomColor = config.defaultAvatarBgColors[
    Math.floor(Math.random() * config.defaultAvatarBgColors.length)
  ];
  element.style.backgroundColor = randomColor;
}

// Close suggestions when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.location-input')) {
    fromSuggestions.style.display = 'none';
    toSuggestions.style.display = 'none';
  }
});
